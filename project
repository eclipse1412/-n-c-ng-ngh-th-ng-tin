
#include<iostream>
#include<string>
#include<fstream>
#include<sstream>
#include<functional>
#include<vector>
#include<ctime>
#include<iomanip>




using namespace std;
//H�m b�m mk :chuy?n �?i ch?i m?t kh?u th�nh gi� tr? chu?i �? b?o m?t
string bamMK(string& matkhau)
{
	hash<string>hashObj;
	size_t hashValue = hashObj(matkhau);
	return to_string(hashValue);
}
//H�m sinh OTP ng?u nhi�n 
string sinhOTP() {
	int otp = rand() % 9000 + 1000; // Sinh s? 4 ch? s?
	return to_string(otp); // Chuy?n s? th�nh chu?i
}
//H�m sinh mk t? �?ng(�? d�i 8 kitu g?m ch? v� s?)
string sinhMKtudong()
{
	string ktu = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
	string MK = "";
	for (int i = 0;i < 8;i++)
	{
		MK += ktu[rand() % ktu.size()];
	}
	return MK;
}
//Struct d?i di?n cho 1 t�i kho?n ng�?i d�ng
struct Taikhoan
{
	string ten, MK, Ngaysinh, cccd,sdt;
	int ViChinh, ViPhu;
	bool admin;
};

class Vi {
private:
	string Id, Owner;
	double TienHienCo;
	vector<string> LichSuGiaoDich;
public:
	Vi(string id, string owner) {
		Id = id;
		Owner = owner;
		TienHienCo = 0.0;
	}
	string getId()const {  //H�m tr? v? Id c?a v�.
		return Id;
	}
	string getOwner()const {  //h�m tr? v? t�n ch? c?a v�.
		return Owner;
	}
	double getMoney()const {  //h�m tr? v? s? ti?n hi?n c� trong t�i kho?n.
		return TienHienCo;
	}
	vector<string> getLSGD()const {  //H�m �? l�u tr? l?ch s? �? giao d?ch.
		return LichSuGiaoDich;
	}
	void AddHistory(string x) {  //Th�m v�o l?ch s? giao �?ch khi n?p, chuy?n ho?c nh?n ti?n.
		LichSuGiaoDich.push_back(x);
	}
	void HienLs()const {  //Ch��ng trinh gi�p hi?n th? to�n b? l?ch s? giao d?ch.
		for (int i = 0; i < LichSuGiaoDich.size(); i++) {
			cout << "-" << LichSuGiaoDich[i] << endl;
		}
	}
	void Gui(double amount) {  //Ch��ng tr?nh d�ng �? c?ng ti?n v�o t�i kho?ng khi n?p ti?n v�o ho?c nh?n ��?c t? tk kh�c.
		TienHienCo += amount;
		AddHistory("Da Nhan: +" + to_string(amount));
	}
	bool Rut(double amount) {  //Ch��ng tr?nh d�ng de rut tien ho?c b? tr? khi chuy?n ti?n.
		if (TienHienCo >= amount) {
			TienHienCo -= amount;
			AddHistory("Da rut: -" + to_string(amount));
			return true;
		}
		return false;
	}
};
class QLVi {
private:
	vector<Vi> vi;
public:
	void TaoVi(const string& Owner) {
		string Id = "W" + to_string(vi.size() + 1000);
		vi.emplace_back(Id, Owner);
		cout << "Id cua vi ban la: " << Id << endl;
		cout << "Chu vi: " << Owner << endl;
		LuuVi();
	}

	void LuuVi() {
		ofstream Out("wallets.txt");
		for (auto& x : vi) {
			Out << x.getId() << "," << x.getOwner() << "," << x.getMoney();
			for (auto& y : x.getLSGD()) {
				Out << "," << y;
			}
			Out << endl;
		}
	}

	void TaiVi() {
    vi.clear();
    ifstream In("wallets.txt");
    
    if (!In.is_open()) {
        cout << "Kh�ng t?m th?y file wallets.txt ho?c file tr?ng" << endl;
        return;
    }

    string line;
    while (getline(In, line)) {
        if (line.empty()) continue;
        
        stringstream ss(line);
        string id, owner, money;
        
        if (!getline(ss, id, ',') || 
            !getline(ss, owner, ',') || 
            !getline(ss, money, ',')) {
            cerr << "D?ng kh�ng h?p l?: " << line << endl;
            continue;
        }

        try {
            Vi v(id, owner);
            v.Gui(stod(money));
            
            string history;
            while (getline(ss, history, ',')) {
                v.AddHistory(history);
            }
            
            vi.push_back(v);
        } catch (const std::exception& e) {
            cerr << "L?i x? l? d?ng: " << line << " - " << e.what() << endl;
        }
    }
}

	bool ChuyenTien(const string& x, const string& y, double amount) {
		Vi* ViDau = nullptr;
		Vi* ViDich = nullptr;
		for (auto& w : vi) {
			if (w.getId() == x) ViDau = &w;
			if (w.getId() == y) ViDich = &w;
		}
		if (ViDau && ViDich) {
			if (ViDau->Rut(amount)) {
				ViDich->Gui(amount);
				ViDau->AddHistory("Da chuyen " + to_string(amount) + " den " + ViDich->getId());
				ViDich->AddHistory("Da nhan " + to_string(amount) + " tu " + ViDau->getId());
				LuuVi();
				return true;
			}
			cout << "So du khong du!\n";
		}
		else {
			cout << "Khong tim thay vi nguon hoac dich!\n";
		}
		return false;
	}

	void ThongTinVi(const string& id) {
		for (auto& x : vi) {
			if (x.getId() == id) {
				cout << "\n== Thong tin vi ==\n";
				cout << "ID: " << x.getId() << endl;
				cout << "Chu so huu: " << x.getOwner() << endl;
				cout << "So du: " << x.getMoney() << endl;
				x.HienLs();
				return;
			}
		}
		cout << "Khong tim thay vi!\n";
	}

	bool DaTaoVi(const string& Tk) {
		for (auto& x : vi) {
			if (x.getOwner() == Tk) return true;
		}
		return false;
	}

	bool Nap(const string& Id, double amount) {
		for (auto& x : vi) {
			if (x.getId() == Id) {
				x.Gui(amount);
				LuuVi();
				return true;
			}
		}
		return false;
	}
	string LayViCuaChu(const string& TenChu) {
		for (auto& x : vi) {
			if (x.getOwner() == TenChu) return x.getId();
		}
		return "";
	}
};


class TaiKhoanNguoiDung
{
public:
    string getCurrentUser() const {
        return currentUser;
    }
    
    bool isAdminLoggedIn() const {
        return isAdmin;
    }
    
    void DangXuat() {
        currentUser = "";
        isAdmin = false;
    }
    
    QLVi& getQLVi() {
        return qlVi;
    }
	TaiKhoanNguoiDung(const string& fileTK, const string& fileGD)
    	: FileQuanLyTK(fileTK), FileGD(fileGD), isAdmin(false), qlVi()
	{
    	srand((unsigned)time(0));
	}

	//h�m t?o t�i kho?n m?i
	void taoTK() {
    string TenTK, MK, Ngaysinh, cccd, sdt;
    int ViChinh = 0, ViPhu = 0;
    bool admin = false;
    cout << "Nhap t�n t�i khoan moi: ";
    cin >> TenTK;
    MK = sinhMKtudong();
    cout << "Mat khau duoc tao tu dong: " << MK << endl;
    cout << "Nhap ng�y sinh (dd/mm/yyyy): ";
    cin >> Ngaysinh;
    if (Ngaysinh.size() >= 8) {
        if (Ngaysinh[1] == '/')
            Ngaysinh = '0' + Ngaysinh;
        if (Ngaysinh[4] == '/')
            Ngaysinh.insert(3, "0");
    }
    cout << "Nhap so dien thoai:";
    cin >> sdt;
    cout << "Nh�p so can cuoc c�ng d�n: ";
    cin >> cccd;
    
    if (KtTenDangNhap(TenTK)) {
        cout << "T�n T�i Khoan " << TenTK << " da ton tai." << endl;
        return;
    }
    
    if (TenTK == "admin")
        admin = true;

    ofstream xuatFile(FileQuanLyTK, ios::app);
    if (xuatFile.is_open()) {
        xuatFile << TenTK << "," << bamMK(MK) << "," << Ngaysinh << "," << cccd << "," 
                 << sdt << "," << ViChinh << "," << ViPhu << "," << (admin ? '1' : '0') << endl;
        
        // T? �?ng t?o v� khi t?o t�i kho?n
        qlVi.TaoVi(TenTK);
        
        xuatFile.close();
        cout << "T�i Khoan: " << TenTK << " da duoc tao th�nh c�ng." << endl;
    } else {
        cout << "Kh�ng the mo tep de tao T�i Khoan." << endl;
    }
}

	void ThaydoiMatkhau() {
		if (currentUser.empty()) {
			cout << "Vui long dang nhap truoc." << endl;
			return;
		}
		string MKCu, MKMoi, XacnhanMKMoi, NhapOTP;
		cout << "Nhap mat khau cu: ";
		cin >> MKCu;
		if (!KtThongtinTK(currentUser, MKCu)) {
			cout << "Mat khau cu kh�ng ��ng." << endl;
			return;
		}
		// G?i OTP
		string otp = sinhOTP();
		vector<Taikhoan> ds = docDanhSachTK(FileQuanLyTK);
		for (int i = 0;i < ds.size();i++)
		{
			if (ds[i].ten == currentUser)
			{
				cout << "Ma OTP cua ban da duoc gui den so dien thoai:" << ds[i].sdt << ":" << otp << endl;
				break;
			}
		}
		cout << "Nhap OTP: ";
		cin >> NhapOTP;
		if (NhapOTP != otp) {
			cout << "OTP kh�ng ��ng. �?i m?t kh?u th?t b?i." << endl;
			return;
		}

		// �?i m?t kh?u
		cout << "Nh?p m?t kh?u m?i: ";
		cin >> MKMoi;
		cout << "X�c nh?n m?t kh?u m?i: ";
		cin >> XacnhanMKMoi;

		if (MKMoi != XacnhanMKMoi) {
			cout << "M?t kh?u m?i v� x�c nh?n kh�ng kh?p." << endl;
			return;
		}

		vector<Taikhoan> danhSach = docDanhSachTK(FileQuanLyTK);
		for (auto& tk : danhSach) {
			if (tk.ten == currentUser) {
				tk.MK = bamMK(MKMoi); // Hash m?t kh?u m?i
				break;
			}
		}

		LuulaiTaiKhoan(danhSach);
		cout << "�?i m?t kh?u th�nh c�ng." << endl;
	}
	void DangNhap() {
		string tenDN, MK;
		cout << "============= ��NG NH?P ================" << endl;
		cout << "T�n ��ng nh?p: ";
		cin >> tenDN;
		cout << "M?t kh?u: ";
		cin >> MK;

		// Ki?m tra t�i kho?n
		if (!KtThongtinTK(tenDN, MK)) {
			cout << "Sai t�n ��ng nh?p ho?c m?t kh?u." << endl;
			return;
		}
		// Sinh v� hi?n th? OTP
		string otp = sinhOTP();
		// G?i OTP (gi? l?p)
		vector<Taikhoan> ds = docDanhSachTK(FileQuanLyTK);
		bool timThay = false;
		for (int i = 0; i < ds.size(); i++) {
			if (ds[i].ten == tenDN) {
				cout << "M? OTP �? ��?c g?i t?i s? �i?n tho?i: " << ds[i].sdt << ": " << otp << endl;
				timThay = true;
				break;
			}
		}
		if (!timThay) {
			cout << "Kh�ng t?m th?y t�i kho?n �? g?i OTP." << endl;
			return;
		}
		// Nh?p v� x�c th?c OTP
		string nhapOTP1;
		cout << "Nh?p m? OTP: ";
		cin >> nhapOTP1;

		if (nhapOTP1 != otp) {
			cout << "M? OTP kh�ng ��ng. ��ng nh?p th?t b?i." << endl;
			return;
		}
		// Th�nh c�ng
		currentUser = tenDN;
		isAdmin = (tenDN == "admin");
		cout << "��ng nh?p th�nh c�ng. Xin ch�o, " << currentUser << "!" << endl;
		string nhapOTP2;
		cout << "Nh?p m? OTP: ";
		cin >> nhapOTP2;
		if (nhapOTP2 != otp) {
			cout << "M? OTP kh�ng ��ng. ��ng nh?p th?t b?i." << endl;
			return;
		}

		// X�c th?c th�nh c�ng
		currentUser = tenDN;
		for (auto& tk : ds) {
			if (tk.ten == tenDN) {
				isAdmin = tk.admin;
				break;
			}
		}
		cout << "��ng nh?p th�nh c�ng v?i vai tr? " << (isAdmin ? "Qu?n tr? vi�n." : "Ng�?i d�ng.") << endl;
		qlVi.TaiVi(); // Load d? li?u v� sau khi ��ng nh?p
	}
	void XemThongTinVi()
	{
		if (currentUser.empty())
		{
			cout << "Vui l?ng ��ng nh?p tr�?c.\n";
			return;
		}
		string viId = qlVi.LayViCuaChu(currentUser);
		if (viId.empty())
		{
			cout << "B?n ch�a c� v�.\n";
			return;
		}
		qlVi.ThongTinVi(viId);
	}
	void NapTienVaoVi()
	{
		if (currentUser.empty())
		{
			cout << "Vui l?ng ��ng nh?p tr�?c.\n";
			return;
		}
		double amount;
		cout << "Nh?p s? ti?n mu?n n?p: ";
		cin >> amount;
		string viId = qlVi.LayViCuaChu(currentUser);
		if (qlVi.Nap(viId, amount))
		{
			cout << "N?p ti?n th�nh c�ng.\n";
		}
		else
		{
			cout << "N?p ti?n th?t b?i.\n";
		}
	}
	void ChuyenTien()
	{
		if (currentUser.empty())
		{
			cout << "Vui l?ng ��ng nh?p tr�?c.\n";
			return;
		}
		string viDich;
		double amount;
		cout << "Nh?p ID v� nh?n ti?n: ";
		cin >> viDich;
		cout << "Nh?p s? ti?n mu?n chuy?n: ";
		cin >> amount;
		string viGui = qlVi.LayViCuaChu(currentUser);
		if (qlVi.ChuyenTien(viGui, viDich, amount))
		{
			cout << "Chuy?n ti?n th�nh c�ng.\n";
		}
		else
		{
			cout << "Chuy?n ti?n th?t b?i.\n";
		}
	}


	int GuiVaXacNhanOTP(const string& sdt) {
		string otp = sinhOTP();
		cout << "Ma OTP da duoc gui den so dien thoai " << sdt << ": " << otp << endl;
		cout << "Nhap OTP de xac nhan: ";
		string nhapOTP;
		cin >> nhapOTP;
		return nhapOTP == otp;
	}
	// H�m c?p nh?t th�ng tin c� nh�n (d�nh cho user th�?ng)
	 void CapNhatThongTinCaNhan() {
        if (currentUser.empty()) {
            cout << "Vui long dang nhap truoc khi cap nhat thong tin.\n";
            return;
        }

        vector<Taikhoan> ds = docDanhSachTK(FileQuanLyTK);
        int idx = -1;
        for (int i = 0; i < (int)ds.size(); i++) {
            if (ds[i].ten == currentUser) {
                idx = i;
                break;
            }
        }
        
        if (idx == -1) {
            cout << "Khong tim thay tai khoan hien tai.\n";
            return;
        }

        Taikhoan& tk = ds[idx];
        cout << "== Thong tin hien tai cua ban ==\n";
        cout << "Ngay sinh: " << tk.Ngaysinh << endl;
        cout << "CCCD: " << tk.cccd << endl;
        cout << "So dien thoai: " << tk.sdt << endl;

        cout << "Ban muon thay doi truong nao? (1: Ngay sinh, 2: CCCD, 3: SDT, 4: Doi mat khau, 0: Huy)\n";
        int chon;
        cin >> chon;
        cin.ignore();

        string noiDungThayDoi = "Ban se thay doi:\n";
        bool thayDoi = false;

        switch (chon) {
            case 1: {
                cout << "Nhap ngay sinh moi (dd/mm/yyyy): ";
                string ns;
                getline(cin, ns);
                noiDungThayDoi += "Ngay sinh tu [" + tk.Ngaysinh + "] thanh [" + ns + "]\n";
                if (!GuiVaXacNhanOTP(tk.sdt)) {
                    cout << "Xac nhan OTP khong thanh cong, huy cap nhat.\n";
                    return;
                }
                tk.Ngaysinh = ns;
                thayDoi = true;
                break;
            }
            case 2: {
                cout << "Nhap CCCD moi: ";
                string cccdMoi;
                getline(cin, cccdMoi);
                noiDungThayDoi += "CCCD tu [" + tk.cccd + "] thanh [" + cccdMoi + "]\n";
                if (!GuiVaXacNhanOTP(tk.sdt)) {
                    cout << "Xac nhan OTP khong thanh cong, huy cap nhat.\n";
                    return;
                }
                tk.cccd = cccdMoi;
                thayDoi = true;
                break;
            }
            case 3: {
                cout << "Nhap so dien thoai moi: ";
                string sdtMoi;
                getline(cin, sdtMoi);
                noiDungThayDoi += "SDT tu [" + tk.sdt + "] thanh [" + sdtMoi + "]\n";
                if (!GuiVaXacNhanOTP(tk.sdt)) {
                    cout << "Xac nhan OTP khong thanh cong, huy cap nhat.\n";
                    return;
                }
                tk.sdt = sdtMoi;
                thayDoi = true;
                break;
            }
            case 4: {
                cout << "Nhap mat khau cu: ";
                string mkCu;
                cin >> mkCu;
                if (bamMK(mkCu) != tk.MK) {
                    cout << "Mat khau cu khong dung.\n";
                    return;
                }
                cout << "Nhap mat khau moi: ";
                string mkMoi1, mkMoi2;
                cin >> mkMoi1;
                cout << "Xac nhan mat khau moi: ";
                cin >> mkMoi2;
                if (mkMoi1 != mkMoi2) {
                    cout << "Mat khau xac nhan khong khop.\n";
                    return;
                }
                noiDungThayDoi += "Mat khau duoc thay doi.\n";
                if (!GuiVaXacNhanOTP(tk.sdt)) {
                    cout << "Xac nhan OTP khong thanh cong, huy cap nhat.\n";
                    return;
                }
                tk.MK = bamMK(mkMoi1);
                thayDoi = true;
                break;
            }
            case 0:
                cout << "Huy cap nhat.\n";
                return;
            default:
                cout << "Lua chon khong hop le.\n";
                return;
        }

        if (thayDoi) {
            LuulaiTaiKhoan(ds);
            cout << "Cap nhat thanh cong.\n";
        }
    }
	// H�m admin ch?nh s?a th�ng tin t�i kho?n kh�c
	void AdminChinhSuaTaiKhoan() {
		if (!isAdmin) {
			cout << "Chi admin moi co quyen chinh sua thong tin tai khoan khac.\n";
			return;
		}

		cout << "Nhap ten tai khoan can chinh sua: ";
		string tkChinhSua;
		cin >> tkChinhSua;

		if (tkChinhSua == "admin") {
			cout << "Khong duoc phep thay doi tai khoan admin.\n";
			return;
		}

		vector<Taikhoan> ds = docDanhSachTK(FileQuanLyTK);
		int idx = -1;
		for (int i = 0; i < (int)ds.size(); i++) {
			if (ds[i].ten == tkChinhSua) {
				idx = i;
				break;
			}
		}

		if (idx == -1) {
			cout << "Khong tim thay tai khoan " << tkChinhSua << ".\n";
			return;
		}

		Taikhoan& tk = ds[idx];
		cout << "== Thong tin hien tai cua tai khoan " << tkChinhSua << " ==\n";
		cout << "Ngay sinh: " << tk.Ngaysinh << endl;
		cout << "CCCD: " << tk.cccd << endl;
		cout << "So dien thoai: " << tk.sdt << endl;

		cout << "Ban muon thay doi truong nao? (1: Ngay sinh, 2: CCCD, 3: SDT, 4: Reset mat khau, 0: Huy)\n";
		int chon;
		cin >> chon;
		cin.ignore();

		bool thayDoi = false;
		switch (chon) {
		case 1: {
			cout << "Nhap ngay sinh moi (dd/mm/yyyy): ";
			string ns;
			getline(cin, ns);
			tk.Ngaysinh = ns;
			thayDoi = true;
			break;
		}
		case 2: {
			cout << "Nhap CCCD moi: ";
			string cccdMoi;
			getline(cin, cccdMoi);
			tk.cccd = cccdMoi;
			thayDoi = true;
			break;
		}
		case 3: {
			cout << "Nhap so dien thoai moi: ";
			string sdtMoi;
			getline(cin, sdtMoi);
			tk.sdt = sdtMoi;
			thayDoi = true;
			break;
		}
		case 4: {
			string mkMoi = sinhMKtudong();
			cout << "Mat khau moi duoc tao tu dong: " << mkMoi << endl;
			tk.MK = bamMK(mkMoi);
			thayDoi = true;
			break;
		}
		case 0:
			cout << "Huy cap nhat.\n";
			return;
		default:
			cout << "Lua chon khong hop le.\n";
			return;
		}

		if (thayDoi) {
			LuulaiTaiKhoan(ds);
			cout << "Cap nhat thanh cong.\n";
		}
	}
    // H�m cho ph�p t?o v� th�ng qua d?i tu?ng qlVi b�n trong class
    void TaoViChoNguoiDung(const string& tenChuVi) {
        qlVi.TaoVi(tenChuVi);
    }



private:
	string FileQuanLyTK;//File l�u tt t�i kho?n
	string FileGD;//File l�u l?ch s? giao d?ch
	string currentUser;//t�n t�i kho?n hi?n t?i
	bool isAdmin;//quy?n admin
	QLVi qlVi;//Qu?n l� v� gi� l?p

	bool KtTenDangNhap( string TenDN)
	{
		ifstream nhapfile(FileQuanLyTK);
		string tmp;
		while (getline(nhapfile, tmp))
		{
			stringstream ss(tmp);
			string TenTkinFile;
			getline(ss, TenTkinFile, ',');
			if (TenTkinFile == TenDN)
			{
				nhapfile.close();
				return 1;
			}
		}
		nhapfile.close();
		return 0;
	}
	bool KtThongtinTK(string TenTK, string MK)
	{
		ifstream nhapFile(FileQuanLyTK);
		string tmp;
		while (getline(nhapFile, tmp))
		{
			stringstream ss(tmp);
			string TenTKinFile, MKinFile;
			getline(ss, TenTKinFile, ',');
			getline(ss, MKinFile, ',');
			if (TenTKinFile == TenTK && MKinFile == bamMK(MK))
			{
				nhapFile.close();
				return 1;
			}
		}
		nhapFile.close();
		return 0;
	}
	void LuulaiTaiKhoan(vector<Taikhoan>& danhsachTaiKhoan)
	{
		ofstream xuatFile(FileQuanLyTK);
		if (!xuatFile.is_open()) {
			cout << "Kh�ng th? m? t?p �? ghi T�i Kho?n" << endl;
			return;
		}
		for (size_t i = 0; i < danhsachTaiKhoan.size(); i++)
		{
			xuatFile << danhsachTaiKhoan[i].ten << ","
				<< danhsachTaiKhoan[i].MK << ","
				<< danhsachTaiKhoan[i].Ngaysinh << ","
				<< danhsachTaiKhoan[i].cccd << ","
				<< danhsachTaiKhoan[i].sdt << ","
				<< danhsachTaiKhoan[i].ViChinh << ","
				<< danhsachTaiKhoan[i].ViPhu << ","
				<< (danhsachTaiKhoan[i].admin ? "1" : "0")
				<< endl;
		}
		xuatFile.close();
	}
	vector<Taikhoan> docDanhSachTK(string& tenFile) {
    vector<Taikhoan> danhSach;
    ifstream nhapFile(tenFile);
    if (!nhapFile.is_open()) {
        cout << "Kh�ng th? m? file " << tenFile << endl;
        return danhSach;
    }

    string tmp;
    while (getline(nhapFile, tmp)) {
        stringstream ss(tmp);
        Taikhoan tk;
        string adminStr, ViChinhStr, ViPhuStr;

        // �?c c�c tr�?ng theo ��ng th? t? v� ph�n c�ch b?ng d?u ph?y
        getline(ss, tk.ten, ',');
        getline(ss, tk.MK, ',');
        getline(ss, tk.Ngaysinh, ',');
        getline(ss, tk.cccd, ',');
        getline(ss, tk.sdt, ',');
        getline(ss, ViChinhStr, ',');
        getline(ss, ViPhuStr, ',');
        getline(ss, adminStr);

        // Chuy?n �?i c�c tr�?ng s?
        try {
            tk.ViChinh = ViChinhStr.empty() ? 0 : stoi(ViChinhStr);
            tk.ViPhu = ViPhuStr.empty() ? 0 : stoi(ViPhuStr);
            tk.admin = (adminStr == "1");
        } catch (const std::invalid_argument& e) {
            cerr << "L?i chuy?n �?i s?: " << e.what() << endl;
            continue; // B? qua d?ng l?i
        }

        danhSach.push_back(tk);
    }
    nhapFile.close();
    return danhSach;
    }
};

int main() {
	srand(time(0));
    TaiKhoanNguoiDung qlTK("accounts.txt", "transactions.txt");
    int choice;
    
    do {
        cout << "\n============= HE THONG QUAN LY TAI KHOAN =============\n";
        cout << "1. Dang nhap\n";
        cout << "2. Tao tai khoan moi\n";
        cout << "3. Thoat\n";
        cout << "Lua chon cua ban: ";
        cin >> choice;
        
        switch(choice) {
            case 1: {
                qlTK.DangNhap();
                if (!qlTK.getCurrentUser().empty()) {
                    int userChoice;
                    do {
                        cout << "\n============= MENU NGUOI DUNG =============\n";
                        cout << "1. Xem thong tin vi\n";
                        cout << "2. Nap tien vao vi\n";
                        cout << "3. Chuyen tien\n";
                        cout << "4. Thay doi mat khau\n";
                        cout << "5. Cap nhat thong tin ca nhan\n";
                        
                        // N?u l� admin
                        if (qlTK.isAdminLoggedIn()) {
                            cout << "6. Quan ly tai khoan (Admin)\n";
                            cout << "7. Tao vi moi\n";
                        }
                        
                        cout << "0. Dang xuat\n";
                        cout << "Lua chon cua ban: ";
                        cin >> userChoice;
                        
                        switch(userChoice) {
                            case 1:
                                qlTK.XemThongTinVi();
                                break;
                            case 2:
                                qlTK.NapTienVaoVi();
                                break;
                            case 3:
                                qlTK.ChuyenTien();
                                break;
                            case 4:
                                qlTK.ThaydoiMatkhau();
                                break;
                            case 5:
                                qlTK.CapNhatThongTinCaNhan();
                                break;
                            case 6:
                                if (qlTK.isAdminLoggedIn()) {
                                    qlTK.AdminChinhSuaTaiKhoan();
                                }
                                break;
                            case 7:
                                if (qlTK.isAdminLoggedIn()) {
                                    string owner;
                                    cout << "Nhap ten chu vi: ";
                                    cin >> owner;
                                    qlTK.TaoViChoNguoiDung(owner); // g?i h�m public m?i

                                }
                                break;
                            case 0:
                                qlTK.DangXuat();
                                cout << "Da dang xuat thanh cong.\n";
                                break;
                            default:
                                cout << "Lua chon khong hop le.\n";
                        }
                    } while (userChoice != 0);
                }
                break;
            }
            case 2:
                qlTK.taoTK();
                break;
            case 3:
                cout << "Cam on ban da su dung dich vu!\n";
                break;
            default:
                cout << "Lua chon khong hop le. Vui long chon lai.\n";
        }
    } while (choice != 3);
    
    return 0;
}
